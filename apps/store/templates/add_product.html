{% extends "index.html" %}
{% block title %}
    Добавление нового товара
{% endblock %}

{% block page_scripts %}

$(document).ready(function() {

    GetCategories();

    $('#parent_categories').change(function() {
        GetCategories();
    });

    $('#categories').change(function() {
        GetDetails();
    });

    function GetCategories()
    {
        $.ajax({
                url : "/store/get_subcategories/", // the endpoint
                type : "GET",
                dataType: 'json',
                contentType: "application/json",
                data : {
                    category : $('#parent_categories').val()
                }, // data sent with the post request
                // handle a successful response
                success : function(data, textStatus, jqXHR) {
                    var result = JSON.parse(data);

                    $('#categories').empty();

                    $.each(result, function (i, item) {
                        $('#categories').append($('<option>', {
                            value: item.pk,
                            text : item.fields.name
                        }));
                    });
                },

                // handle a non-successful response
                error : function(xhr,errmsg,err) {
                    alert("error!");
                }
        });
    }

    function GetDetails()
    {
        $.ajax({
                url : "/store/get_product_details/", // the endpoint
                type : "GET",
                dataType: 'json',
                contentType: "application/json",
                data : {
                    category : $('#categories').val()
                }, // data sent with the post request
                // handle a successful response
                success : function(data, textStatus, jqXHR) {
                    $('#MainDetails').empty();
                    $('#SubDetails').empty();

                    main_details = data['main'];
                    sub_details = data['sub'];

                    var header = $('<h4>Основные характеристики товара</h4>');
                    $( "#MainDetails" ).append(header);
                    i=0;
                    for(key in main_details)
                    {
                        for(name in main_details[key])
                        {

                            var detail_label = $('<p id="' + i + '"></p>').text(name);

                            var detail_select = $('<select id="select_' + i +'" /><br>');
                            $.each(main_details[key][name], function (c, item) {
                                $('<option>', {
                                    value: item.id,
                                    text : item.stringValue
                                }).appendTo(detail_select);
                            });

                            $( "#MainDetails" ).append(detail_label).append(detail_select).append('<br>')   ;
                            i++;
                        }
                    }

                    var header = $('<h4>Дополнительные характеристики товара</h4>');
                    $( "#SubDetails" ).append(header);
                    i=0;
                    for(key in sub_details)
                    {
                        for(name in sub_details[key])
                        {

                            var detail_label = $('<p id="sub_' + i + '"></p>').text(name);

                            var detail_select = $('<select id="sub_select_' + i +'" />');
                            $.each(sub_details[key][name], function (c, item) {
                                $('<option>', {
                                    value: item.id,
                                    text : item.stringValue
                                }).appendTo(detail_select);
                            });

                            $( "#SubDetails" ).append(detail_label).append(detail_select).append(count_input).append('<br>').append('<br>');
                            i++;
                        }
                    }
                    var count_label = $('<p id="count_' + i + '"></p>').text('Количество');
                    var count_input = $('<input id="count_input_' + i + '" type="text"/>')
                    $( "#SubDetails" ).append(count_label).append(count_input).append('<br>')
                },

                // handle a non-successful response
                error : function(xhr,errmsg,err) {
                    alert("error!");
                }
        });
    }

});

{% endblock %}

{% block content %}
    <h3>Новый товар</h3>

{{form.errors}}

{% if form.errors %}
    {% for field in form %}
        {% for error in field.errors %}
            <p> {{ errors }} </p>
        {% endfor %}
    {% endfor %}
{% endif %}
<br>
<div class="fieldWrapper">
    <label>Родительская категория</label><br>
    {{ product_form.parent_category }}
</div>
<br>
<div class="fieldWrapper">
    <label>Категория</label><br>
    {{ product_form.category }}
</div>
<br>
<div class="fieldWrapper">
    <label>Название</label><br>
    {{ product_form.name }}
</div>
<br>
<div class="fieldWrapper">
    <label>Описание</label><br>
    {{ product_form.description }}
</div>

<br>

<div id="MainDetails" >

</div>

<br>

<div id="SubDetails" >

</div>
<br>
<br>
{% endblock %}
